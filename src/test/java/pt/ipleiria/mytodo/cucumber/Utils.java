package pt.ipleiria.mytodo.cucumber;

import java.io.FileReader;
import java.lang.Exception;
import java.lang.String;
import java.net.URL;
import java.util.Arrays;
import java.util.Iterator;
import java.util.List;
import java.util.Map;
import java.util.concurrent.TimeUnit;
import java.util.function.Function;

import io.appium.java_client.TouchAction;
import io.appium.java_client.android.AndroidDriver;
import io.appium.java_client.android.AndroidElement;
import io.appium.java_client.touch.TapOptions;
import io.appium.java_client.touch.offset.ElementOption;
import io.cucumber.java.Scenario;
import org.json.simple.JSONArray;
import org.json.simple.JSONObject;
import org.json.simple.parser.JSONParser;
import org.openqa.selenium.By;
import org.openqa.selenium.Keys;
import org.openqa.selenium.remote.DesiredCapabilities;

/**
 * This class was automatically generated by TestProject
 * Adds various utilities used by TestProject generated tests
 */
public class Utils {
  /**
   * Adds a pause before/after steps based on test and step-specific settings.
   */
  public static void sleep(int milliseconds) throws Exception {
    try {
      TimeUnit.MILLISECONDS.sleep(milliseconds);
    }
    catch (Exception e) {
      throw new Exception("Pause between steps was interrupted", e);
    }
  }

  /**
   * Converts an array of comma-separated keys (e.g. TAB) for use by sendKeys() method.
   * See https://goo.gl/jg18sk for the full list of keys
   */
  public static Keys[] getKeys(String keyString) {
    String[] keyArray = keyString.split(",");
    Function<String, Keys> func = s -> Keys.valueOf(s);
    return Arrays.stream(keyArray).map(func).toArray(Keys[]::new);
  }


  public static AndroidDriver setUp(String conf, Scenario scenario, int env) throws Exception {
    JSONParser parser = new JSONParser();
    JSONObject config = (JSONObject) parser.parse(new FileReader(conf));
    JSONArray envs = (JSONArray) config.get("environments");

    DesiredCapabilities capabilities = new DesiredCapabilities();

    Map<String, String> envCapabilities = (Map<String, String>) envs.get(env); //selecting device index
    Iterator it = envCapabilities.entrySet().iterator();
    while (it.hasNext()) {
      Map.Entry pair = (Map.Entry)it.next();
      capabilities.setCapability(pair.getKey().toString(), pair.getValue().toString());
    }

    Map<String, String> commonCapabilities = (Map<String, String>) config.get("capabilities");
    it = commonCapabilities.entrySet().iterator();
    while (it.hasNext()) {
      Map.Entry pair = (Map.Entry)it.next();
      if(capabilities.getCapability(pair.getKey().toString()) == null){
        capabilities.setCapability(pair.getKey().toString(), pair.getValue().toString());
      }
    }

    capabilities.setCapability("name", scenario.getName());

    String username = System.getenv("BROWSERSTACK_USERNAME");
    if(username == null) {
      username = (String) config.get("username");
    }

    String accessKey = System.getenv("BROWSERSTACK_ACCESS_KEY");
    if(accessKey == null) {
      accessKey = (String) config.get("access_key");
    }

    String app = System.getenv("BROWSERSTACK_APP_ID");
    if(app != null && !app.isEmpty()) {
      capabilities.setCapability("app", app);
    }

    return new AndroidDriver(new URL("http://"+username+":"+accessKey+"@"+config.get("server")+"/wd/hub"), capabilities);
  }

  public static List<AndroidElement> waitForSafe(AndroidDriver driver, By by, int seconds) throws Exception{
    int loops = seconds * 2;
    List<AndroidElement> list = driver.findElements(by);
    while (list.size() == 0 && loops > 0){
      Utils.sleep(500);
      list = driver.findElements(by);
      loops --;
    }
    return list;
  }

  public static List<AndroidElement> waitFor(AndroidDriver driver, By by, int seconds) throws Exception{
    List<AndroidElement> list = waitForSafe(driver, by, seconds);
    if(list.size() == 0) throw new Exception();
    return list;
  }

  public static AndroidElement waitForElementSafe(AndroidDriver driver, By by, int seconds) throws Exception{
    List<AndroidElement> list = waitForSafe(driver, by, seconds);
    if(list.size() == 0) return null;
    return list.get(0);
  }

  public static AndroidElement waitForElement(AndroidDriver driver, By by, int seconds) throws Exception{
    AndroidElement el = waitForElementSafe(driver, by, seconds);
    if(el == null) throw new Exception();
    return el;
  }

  public static void waitForAndTouch(AndroidDriver driver, By by, int seconds) throws Exception{
    AndroidElement el = waitForElement(driver, by, seconds);
    (new TouchAction((driver))).tap(TapOptions.tapOptions().withElement(ElementOption.element(el))).perform();
  }

}
